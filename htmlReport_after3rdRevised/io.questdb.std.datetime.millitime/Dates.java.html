<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Dates.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">All in questdb Coverage Results, io.questdb in questdb Coverage Results</a> &gt; <a href="index.source.html" class="el_package">io.questdb.std.datetime.millitime</a> &gt; <span class="el_source">Dates.java</span></div><h1>Dates.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 *     ___                  _   ____  ____
 *    / _ \ _   _  ___  ___| |_|  _ \| __ )
 *   | | | | | | |/ _ \/ __| __| | | |  _ \
 *   | |_| | |_| |  __/\__ \ |_| |_| | |_) |
 *    \__\_\\__,_|\___||___/\__|____/|____/
 *
 *  Copyright (c) 2014-2019 Appsicle
 *  Copyright (c) 2019-2022 QuestDB
 *
 *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 ******************************************************************************/

package io.questdb.std.datetime.millitime;

import io.questdb.std.Chars;
import io.questdb.std.Misc;
import io.questdb.std.Numbers;
import io.questdb.std.NumericException;
import io.questdb.std.str.StringSink;

public final class Dates {

    public static final long DAY_MILLIS = 86400000L;
    public static final long HOUR_MILLIS = 3600000L;
    public static final long MINUTE_MILLIS = 60000;
    public static final long SECOND_MILLIS = 1000;
    public static final int STATE_DELIM = 4;
    public static final int STATE_END = 6;
    public static final int STATE_GMT = 2;
    public static final int STATE_HOUR = 3;
    public static final int STATE_INIT = 0;
    public static final int STATE_MINUTE = 5;
    public static final int STATE_SIGN = 7;
    public static final int STATE_UTC = 1;
    private static final char AFTER_NINE = '9' + 1;
    private static final long AVG_YEAR_MILLIS = (long) (365.2425 * DAY_MILLIS);
    private static final long HALF_YEAR_MILLIS = AVG_YEAR_MILLIS / 2;
    private static final long EPOCH_MILLIS = 1970L * AVG_YEAR_MILLIS;
    private static final long HALF_EPOCH_MILLIS = EPOCH_MILLIS / 2;
    private static final char BEFORE_ZERO = '0' - 1;
    private static final int DAYS_0000_TO_1970 = 719527;
<span class="fc" id="L54">    private static final int[] DAYS_PER_MONTH = {</span>
            31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31
    };
    private static final int DAY_HOURS = 24;
    private static final int HOUR_MINUTES = 60;
    private static final long LEAP_YEAR_MILLIS = 366 * DAY_MILLIS;
<span class="fc" id="L60">    private static final long[] MAX_MONTH_OF_YEAR_MILLIS = new long[12];</span>
    private static final int MINUTE_SECONDS = 60;
<span class="fc" id="L62">    private static final long[] MIN_MONTH_OF_YEAR_MILLIS = new long[12];</span>
    private static final long YEAR_MILLIS = 365 * DAY_MILLIS;

    private Dates() {
    }

    public static long addDays(long millis, int days) {
<span class="fc" id="L69">        return millis + days * DAY_MILLIS;</span>
    }

    public static long addHours(long millis, int hours) {
<span class="nc" id="L73">        return millis + hours * HOUR_MILLIS;</span>
    }

    public static long addMonths(final long millis, int months) {
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">        if (months == 0) {</span>
<span class="nc" id="L78">            return millis;</span>
        }
<span class="fc" id="L80">        int y = getYear(millis);</span>
<span class="fc" id="L81">        boolean l = isLeapYear(y);</span>
<span class="fc" id="L82">        int m = getMonthOfYear(millis, y, l);</span>
        int _y;
<span class="fc" id="L84">        int _m = m - 1 + months;</span>
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">        if (_m &gt; -1) {</span>
<span class="nc" id="L86">            _y = y + _m / 12;</span>
<span class="nc" id="L87">            _m = (_m % 12) + 1;</span>
        } else {
<span class="fc" id="L89">            _y = y + _m / 12 - 1;</span>
<span class="fc" id="L90">            _m = -_m % 12;</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">            if (_m == 0) {</span>
<span class="nc" id="L92">                _m = 12;</span>
            }
<span class="fc" id="L94">            _m = 12 - _m + 1;</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">            if (_m == 1) {</span>
<span class="nc" id="L96">                _y += 1;</span>
            }
        }
<span class="fc" id="L99">        int _d = getDayOfMonth(millis, y, m, l);</span>
<span class="fc" id="L100">        int maxDay = getDaysPerMonth(_m, isLeapYear(_y));</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if (_d &gt; maxDay) {</span>
<span class="nc" id="L102">            _d = maxDay;</span>
        }
<span class="fc bfc" id="L104" title="All 2 branches covered.">        return toMillis(_y, _m, _d) + getTime(millis) + (millis &lt; 0 ? 1 : 0);</span>
    }

    public static long addYear(long millis, int years) {
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">        if (years == 0) {</span>
<span class="nc" id="L109">            return millis;</span>
        }

<span class="fc" id="L112">        int y = getYear(millis);</span>
        int m;
<span class="fc" id="L114">        boolean leap1 = isLeapYear(y);</span>
<span class="fc" id="L115">        boolean leap2 = isLeapYear(y + years);</span>

<span class="fc" id="L117">        return yearMillis(y + years, leap2)</span>
<span class="fc" id="L118">                + monthOfYearMillis(m = getMonthOfYear(millis, y, leap1), leap2)</span>
<span class="fc" id="L119">                + (getDayOfMonth(millis, y, m, leap1) - 1) * DAY_MILLIS</span>
<span class="fc" id="L120">                + getTime(millis)</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">                + (millis &lt; 0 ? 1 : 0);</span>

    }

    public static long ceilDD(long millis) {
        int y, m;
        boolean l;
<span class="fc" id="L128">        return yearMillis(y = getYear(millis), l = isLeapYear(y))</span>
<span class="fc" id="L129">                + monthOfYearMillis(m = getMonthOfYear(millis, y, l), l)</span>
<span class="fc" id="L130">                + (getDayOfMonth(millis, y, m, l) - 1) * DAY_MILLIS</span>
                + 23 * HOUR_MILLIS
                + 59 * MINUTE_MILLIS
                + 59 * SECOND_MILLIS
                + 999L
                ;
    }

    public static long ceilMM(long millis) {
        int y, m;
        boolean l;
<span class="fc" id="L141">        return yearMillis(y = getYear(millis), l = isLeapYear(y))</span>
<span class="fc" id="L142">                + monthOfYearMillis(m = getMonthOfYear(millis, y, l), l)</span>
<span class="fc" id="L143">                + (getDaysPerMonth(m, l) - 1) * DAY_MILLIS</span>
                + 23 * HOUR_MILLIS
                + 59 * MINUTE_MILLIS
                + 59 * SECOND_MILLIS
                + 999L
                ;
    }

    public static long ceilYYYY(long millis) {
        int y;
        boolean l;
<span class="fc" id="L154">        return yearMillis(y = getYear(millis), l = isLeapYear(y))</span>
<span class="fc" id="L155">                + monthOfYearMillis(12, l)</span>
                + (DAYS_PER_MONTH[11] - 1) * DAY_MILLIS
                + 23 * HOUR_MILLIS
                + 59 * MINUTE_MILLIS
                + 59 * SECOND_MILLIS
                + 999L;
    }

    public static long endOfYear(int year) {
<span class="fc" id="L164">        return toMillis(year, 12, 31, 23, 59) + 59 * 1000L + 999L;</span>
    }

    public static long floorDD(long millis) {
<span class="fc" id="L168">        return millis - getTime(millis);</span>
    }

    public static long floorHH(long millis) {
<span class="fc" id="L172">        return millis - millis % HOUR_MILLIS;</span>
    }

    public static long floorMI(long millis) {
<span class="nc" id="L176">        return millis - millis % MINUTE_MILLIS;</span>
    }

    public static long floorMM(long millis) {
        int y;
        boolean l;
<span class="fc" id="L182">        return yearMillis(y = getYear(millis), l = isLeapYear(y)) + monthOfYearMillis(getMonthOfYear(millis, y, l), l);</span>
    }

    public static long floorYYYY(long millis) {
        int y;
<span class="fc" id="L187">        return yearMillis(y = getYear(millis), isLeapYear(y));</span>
    }

    public static int getDayOfMonth(long millis, int year, int month, boolean leap) {
<span class="fc" id="L191">        long dateMillis = yearMillis(year, leap);</span>
<span class="fc" id="L192">        dateMillis += monthOfYearMillis(month, leap);</span>
<span class="fc" id="L193">        return (int) ((millis - dateMillis) / DAY_MILLIS) + 1;</span>
    }

    public static int getDayOfWeek(long millis) {
        // 1970-01-01 is Thursday.
        long d;
<span class="fc bfc" id="L199" title="All 2 branches covered.">        if (millis &gt; -1) {</span>
<span class="fc" id="L200">            d = millis / DAY_MILLIS;</span>
        } else {
<span class="fc" id="L202">            d = (millis - (DAY_MILLIS - 1)) / DAY_MILLIS;</span>
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">            if (d &lt; -3) {</span>
<span class="fc" id="L204">                return 7 + (int) ((d + 4) % 7);</span>
            }
        }
<span class="fc" id="L207">        return 1 + (int) ((d + 3) % 7);</span>
    }

    public static int getDayOfWeekSundayFirst(long millis) {
        // 1970-01-01 is Thursday.
        long d;
<span class="fc bfc" id="L213" title="All 2 branches covered.">        if (millis &gt; -1) {</span>
<span class="fc" id="L214">            d = millis / DAY_MILLIS;</span>
        } else {
<span class="fc" id="L216">            d = (millis - (DAY_MILLIS - 1)) / DAY_MILLIS;</span>
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">            if (d &lt; -4) {</span>
<span class="fc" id="L218">                return 7 + (int) ((d + 5) % 7);</span>
            }
        }
<span class="fc" id="L221">        return 1 + (int) ((d + 4) % 7);</span>
    }

    public static int getDayOfYear(long millis) {
<span class="fc" id="L225">        int year = getYear(millis);</span>
<span class="fc" id="L226">        boolean leap = isLeapYear(year);</span>
<span class="fc" id="L227">        long yearStart = yearMillis(year, leap);</span>
<span class="fc" id="L228">        return (int) ((millis - yearStart) / DAY_MILLIS) + 1;</span>
    }

    public static long getDaysBetween(long a, long b) {
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">        if (b &lt; a) {</span>
<span class="nc" id="L233">            return getDaysBetween(b, a);</span>
        } else {
<span class="fc" id="L235">            return (b - a) / DAY_MILLIS;</span>
        }
    }

    /**
     * Days in a given month. This method expects you to know if month is in leap year.
     *
     * @param m    month from 1 to 12
     * @param leap true if this is for leap year
     * @return number of days in month.
     */
    public static int getDaysPerMonth(int m, boolean leap) {
<span class="fc bfc" id="L247" title="All 4 branches covered.">        return leap &amp; m == 2 ? 29 : DAYS_PER_MONTH[m - 1];</span>
    }

    public static int getHourOfDay(long millis) {
<span class="fc bfc" id="L251" title="All 2 branches covered.">        if (millis &gt; -1) {</span>
<span class="fc" id="L252">            return (int) ((millis / HOUR_MILLIS) % DAY_HOURS);</span>
        } else {
<span class="fc" id="L254">            return DAY_HOURS - 1 + (int) (((millis + 1) / HOUR_MILLIS) % DAY_HOURS);</span>
        }
    }

    public static int getMillisOfSecond(long millis) {
<span class="fc bfc" id="L259" title="All 2 branches covered.">        if (millis &gt; -1) {</span>
<span class="fc" id="L260">            return (int) (millis % 1000);</span>
        } else {
<span class="fc" id="L262">            return 1000 - 1 + (int) ((millis + 1) % 1000);</span>
        }
    }

    public static int getMinuteOfHour(long millis) {
<span class="fc bfc" id="L267" title="All 2 branches covered.">        if (millis &gt; -1) {</span>
<span class="fc" id="L268">            return (int) ((millis / MINUTE_MILLIS) % HOUR_MINUTES);</span>
        } else {
<span class="fc" id="L270">            return HOUR_MINUTES - 1 + (int) (((millis + 1) / MINUTE_MILLIS) % HOUR_MINUTES);</span>
        }
    }

    /**
     * Calculates month of year from absolute millis.
     *
     * @param millis millis since 1970
     * @param year   year of month
     * @param leap   true if year was leap
     * @return month of year
     */
    public static int getMonthOfYear(long millis, int year, boolean leap) {
<span class="fc" id="L283">        int i = (int) ((millis - yearMillis(year, leap)) &gt;&gt; 10);</span>
<span class="fc bfc" id="L284" title="All 2 branches covered.">        return leap</span>
<span class="fc bfc" id="L285" title="All 2 branches covered.">                ? ((i &lt; 182 * 84375)</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">                ? ((i &lt; 91 * 84375)</span>
<span class="fc bfc" id="L287" title="All 4 branches covered.">                ? ((i &lt; 31 * 84375) ? 1 : (i &lt; 60 * 84375) ? 2 : 3)</span>
<span class="fc bfc" id="L288" title="All 4 branches covered.">                : ((i &lt; 121 * 84375) ? 4 : (i &lt; 152 * 84375) ? 5 : 6))</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">                : ((i &lt; 274 * 84375)</span>
<span class="fc bfc" id="L290" title="All 4 branches covered.">                ? ((i &lt; 213 * 84375) ? 7 : (i &lt; 244 * 84375) ? 8 : 9)</span>
<span class="fc bfc" id="L291" title="All 4 branches covered.">                : ((i &lt; 305 * 84375) ? 10 : (i &lt; 335 * 84375) ? 11 : 12)))</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">                : ((i &lt; 181 * 84375)</span>
<span class="fc bfc" id="L293" title="All 2 branches covered.">                ? ((i &lt; 90 * 84375)</span>
<span class="fc bfc" id="L294" title="All 4 branches covered.">                ? ((i &lt; 31 * 84375) ? 1 : (i &lt; 59 * 84375) ? 2 : 3)</span>
<span class="fc bfc" id="L295" title="All 4 branches covered.">                : ((i &lt; 120 * 84375) ? 4 : (i &lt; 151 * 84375) ? 5 : 6))</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">                : ((i &lt; 273 * 84375)</span>
<span class="fc bfc" id="L297" title="All 4 branches covered.">                ? ((i &lt; 212 * 84375) ? 7 : (i &lt; 243 * 84375) ? 8 : 9)</span>
<span class="fc bfc" id="L298" title="All 4 branches covered.">                : ((i &lt; 304 * 84375) ? 10 : (i &lt; 334 * 84375) ? 11 : 12)));</span>
    }

    public static long getMonthsBetween(long a, long b) {
<span class="fc bfc" id="L302" title="All 2 branches covered.">        if (b &lt; a) {</span>
<span class="fc" id="L303">            return getMonthsBetween(b, a);</span>
        }

<span class="fc" id="L306">        int aYear = getYear(a);</span>
<span class="fc" id="L307">        int bYear = getYear(b);</span>
<span class="fc" id="L308">        boolean aLeap = isLeapYear(aYear);</span>
<span class="fc" id="L309">        boolean bLeap = isLeapYear(bYear);</span>
<span class="fc" id="L310">        int aMonth = getMonthOfYear(a, aYear, aLeap);</span>
<span class="fc" id="L311">        int bMonth = getMonthOfYear(b, bYear, bLeap);</span>

<span class="fc" id="L313">        long aResidual = a - yearMillis(aYear, aLeap) - monthOfYearMillis(aMonth, aLeap);</span>
<span class="fc" id="L314">        long bResidual = b - yearMillis(bYear, bLeap) - monthOfYearMillis(bMonth, bLeap);</span>
<span class="fc" id="L315">        long months = 12L * (bYear - aYear) + (bMonth - aMonth);</span>

<span class="fc bfc" id="L317" title="All 2 branches covered.">        if (aResidual &gt; bResidual) {</span>
<span class="fc" id="L318">            return months - 1;</span>
        } else {
<span class="fc" id="L320">            return months;</span>
        }
    }

    public static int getSecondOfMinute(long millis) {
<span class="fc bfc" id="L325" title="All 2 branches covered.">        if (millis &gt; -1) {</span>
<span class="fc" id="L326">            return (int) ((millis / SECOND_MILLIS) % MINUTE_SECONDS);</span>
        } else {
<span class="fc" id="L328">            return MINUTE_SECONDS - 1 + (int) (((millis + 1) / SECOND_MILLIS) % MINUTE_SECONDS);</span>
        }
    }

    public static int getWeekOfMonth(long millis) {
<span class="fc" id="L333">        int year = getYear(millis);</span>
<span class="fc" id="L334">        boolean leap = isLeapYear(year);</span>
<span class="fc" id="L335">        return getDayOfMonth(millis, year, getMonthOfYear(millis, year, leap), leap) / 7 + 1;</span>
    }

    public static int getWeekOfYear(long millis) {
<span class="fc" id="L339">        return getDayOfYear(millis) / 7 + 1;</span>
    }

    /**
     * Calculates year number from millis.
     *
     * @param millis time millis.
     * @return year
     */
    public static int getYear(long millis) {
<span class="fc" id="L349">        long mid = (millis &gt;&gt; 1) + HALF_EPOCH_MILLIS;</span>
<span class="fc bfc" id="L350" title="All 2 branches covered.">        if (mid &lt; 0) {</span>
<span class="fc" id="L351">            mid = mid - HALF_YEAR_MILLIS + 1;</span>
        }
<span class="fc" id="L353">        int year = (int) (mid / HALF_YEAR_MILLIS);</span>

<span class="fc" id="L355">        boolean leap = isLeapYear(year);</span>
<span class="fc" id="L356">        long yearStart = yearMillis(year, leap);</span>
<span class="fc" id="L357">        long diff = millis - yearStart;</span>

<span class="fc bfc" id="L359" title="All 2 branches covered.">        if (diff &lt; 0) {</span>
<span class="fc" id="L360">            year--;</span>
<span class="fc bfc" id="L361" title="All 2 branches covered.">        } else if (diff &gt;= YEAR_MILLIS) {</span>
<span class="fc bfc" id="L362" title="All 2 branches covered.">            yearStart += leap ? LEAP_YEAR_MILLIS : YEAR_MILLIS;</span>
<span class="fc bfc" id="L363" title="All 2 branches covered.">            if (yearStart &lt;= millis) {</span>
<span class="fc" id="L364">                year++;</span>
            }
        }

<span class="fc" id="L368">        return year;</span>
    }

    public static long getYearsBetween(long a, long b) {
<span class="fc" id="L372">        return getMonthsBetween(a, b) / 12;</span>
    }

    /**
     * Calculates if year is leap year using following algorithm:
     * &lt;p&gt;
     * http://en.wikipedia.org/wiki/Leap_year
     *
     * @param year the year
     * @return true if year is leap
     */
    public static boolean isLeapYear(int year) {
<span class="fc bfc" id="L384" title="All 6 branches covered.">        return ((year &amp; 3) == 0) &amp;&amp; ((year % 100) != 0 || (year % 400) == 0);</span>
    }

    public static long monthOfYearMillis(int month, boolean leap) {
<span class="fc bfc" id="L388" title="All 2 branches covered.">        return leap ? MAX_MONTH_OF_YEAR_MILLIS[month - 1] : MIN_MONTH_OF_YEAR_MILLIS[month - 1];</span>
    }

    public static long nextOrSameDayOfWeek(long millis, int dow) {
<span class="fc" id="L392">        int thisDow = getDayOfWeek(millis);</span>
<span class="fc bfc" id="L393" title="All 2 branches covered.">        if (thisDow == dow) {</span>
<span class="fc" id="L394">            return millis;</span>
        }

<span class="fc bfc" id="L397" title="All 2 branches covered.">        if (thisDow &lt; dow) {</span>
<span class="fc" id="L398">            return millis + (dow - thisDow) * DAY_MILLIS;</span>
        } else {
<span class="fc" id="L400">            return millis + (7 - (thisDow - dow)) * DAY_MILLIS;</span>
        }
    }

    public static long parseOffset(CharSequence in, int lo, int hi) {
<span class="fc" id="L405">        int p = lo;</span>
<span class="fc" id="L406">        int state = STATE_INIT;</span>
<span class="fc" id="L407">        boolean negative = false;</span>
<span class="fc" id="L408">        int hour = 0;</span>
<span class="fc" id="L409">        int minute = 0;</span>

        try {
            OUT:
<span class="fc bfc" id="L413" title="All 2 branches covered.">            while (p &lt; hi) {</span>
<span class="fc" id="L414">                char c = in.charAt(p);</span>

<span class="fc bfc" id="L416" title="All 8 branches covered.">                switch (state) {</span>
                    case STATE_INIT:
<span class="fc bfc" id="L418" title="All 6 branches covered.">                        switch (c) {</span>
                            case 'U':
                            case 'u':
<span class="fc" id="L421">                                state = STATE_UTC;</span>
<span class="fc" id="L422">                                break;</span>
                            case 'G':
                            case 'g':
<span class="fc" id="L425">                                state = STATE_GMT;</span>
<span class="fc" id="L426">                                break;</span>
                            case 'Z':
                            case 'z':
<span class="fc" id="L429">                                state = STATE_END;</span>
<span class="fc" id="L430">                                break;</span>
                            case '+':
<span class="fc" id="L432">                                state = STATE_HOUR;</span>
<span class="fc" id="L433">                                break;</span>
                            case '-':
<span class="fc" id="L435">                                negative = true;</span>
<span class="fc" id="L436">                                state = STATE_HOUR;</span>
<span class="fc" id="L437">                                break;</span>
                            default:
<span class="fc bfc" id="L439" title="All 2 branches covered.">                                if (isDigit(c)) {</span>
<span class="fc" id="L440">                                    state = STATE_HOUR;</span>
<span class="fc" id="L441">                                    p--;</span>
                                } else {
<span class="fc" id="L443">                                    return Long.MIN_VALUE;</span>
                                }
                                break;
                        }
<span class="fc" id="L447">                        p++;</span>
<span class="fc" id="L448">                        break;</span>
                    case STATE_UTC:
<span class="pc bpc" id="L450" title="1 of 4 branches missed.">                        if (p &gt; hi - 2 || Chars.noMatch(in, p, p + 2, &quot;tc&quot;, 0, 2)) {</span>
<span class="fc" id="L451">                            return Long.MIN_VALUE;</span>
                        }
<span class="fc" id="L453">                        state = STATE_SIGN;</span>
<span class="fc" id="L454">                        p += 2;</span>
<span class="fc" id="L455">                        break;</span>
                    case STATE_GMT:
<span class="pc bpc" id="L457" title="1 of 4 branches missed.">                        if (p &gt; hi - 2 || Chars.noMatch(in, p, p + 2, &quot;mt&quot;, 0, 2)) {</span>
<span class="fc" id="L458">                            return Long.MIN_VALUE;</span>
                        }
<span class="fc" id="L460">                        state = STATE_SIGN;</span>
<span class="fc" id="L461">                        p += 2;</span>
<span class="fc" id="L462">                        break;</span>
                    case STATE_SIGN:
<span class="fc bfc" id="L464" title="All 3 branches covered.">                        switch (c) {</span>
                            case '+':
<span class="fc" id="L466">                                break;</span>
                            case '-':
<span class="fc" id="L468">                                negative = true;</span>
<span class="fc" id="L469">                                break;</span>
                            default:
<span class="fc" id="L471">                                return Long.MIN_VALUE;</span>
                        }
<span class="fc" id="L473">                        p++;</span>
<span class="fc" id="L474">                        state = STATE_HOUR;</span>
<span class="fc" id="L475">                        break;</span>
                    case STATE_HOUR:
<span class="pc bpc" id="L477" title="1 of 4 branches missed.">                        if (isDigit(c) &amp;&amp; p &lt; hi - 1) {</span>
<span class="fc" id="L478">                            hour = Numbers.parseInt(in, p, p + 2);</span>
                        } else {
<span class="fc" id="L480">                            return Long.MIN_VALUE;</span>
                        }
<span class="fc" id="L482">                        state = STATE_DELIM;</span>
<span class="fc" id="L483">                        p += 2;</span>
<span class="fc" id="L484">                        break;</span>
                    case STATE_DELIM:
<span class="fc bfc" id="L486" title="All 2 branches covered.">                        if (c == ':') {</span>
<span class="fc" id="L487">                            state = STATE_MINUTE;</span>
<span class="fc" id="L488">                            p++;</span>
<span class="fc bfc" id="L489" title="All 2 branches covered.">                        } else if (isDigit(c)) {</span>
<span class="fc" id="L490">                            state = STATE_MINUTE;</span>
                        } else {
<span class="fc" id="L492">                            return Long.MIN_VALUE;</span>
                        }
                        break;
                    case STATE_MINUTE:
<span class="pc bpc" id="L496" title="1 of 4 branches missed.">                        if (isDigit(c) &amp;&amp; p &lt; hi - 1) {</span>
<span class="fc" id="L497">                            minute = Numbers.parseInt(in, p, p + 2);</span>
                        } else {
<span class="fc" id="L499">                            return Long.MIN_VALUE;</span>
                        }
<span class="fc" id="L501">                        p += 2;</span>
<span class="fc" id="L502">                        state = STATE_END;</span>
<span class="fc" id="L503">                        break OUT;</span>
                    default:
<span class="fc" id="L505">                        return Long.MIN_VALUE;</span>
                }
<span class="fc" id="L507">            }</span>
<span class="fc" id="L508">        } catch (NumericException e) {</span>
<span class="fc" id="L509">            return Long.MIN_VALUE;</span>
<span class="fc" id="L510">        }</span>

<span class="fc bfc" id="L512" title="All 2 branches covered.">        switch (state) {</span>
            case STATE_DELIM:
            case STATE_END:
<span class="fc bfc" id="L515" title="All 4 branches covered.">                if (hour &gt; 23 || minute &gt; 59) {</span>
<span class="fc" id="L516">                    return Long.MIN_VALUE;</span>
                }
<span class="fc" id="L518">                final int min = hour * 60 + minute;</span>
<span class="fc bfc" id="L519" title="All 2 branches covered.">                return Numbers.encodeLowHighInts(negative ? -min : min, p - lo);</span>
            default:
<span class="fc" id="L521">                return Long.MIN_VALUE;</span>
        }
    }

    public static long previousOrSameDayOfWeek(long millis, int dow) {
<span class="fc" id="L526">        int thisDow = getDayOfWeek(millis);</span>
<span class="fc bfc" id="L527" title="All 2 branches covered.">        if (thisDow == dow) {</span>
<span class="fc" id="L528">            return millis;</span>
        }

<span class="fc bfc" id="L531" title="All 2 branches covered.">        if (thisDow &lt; dow) {</span>
<span class="fc" id="L532">            return millis - (7 + (thisDow - dow)) * DAY_MILLIS;</span>
        } else {
<span class="fc" id="L534">            return millis - (thisDow - dow) * DAY_MILLIS;</span>
        }
    }

    public static long toMillis(int y, int m, int d, int h, int mi) {
<span class="fc" id="L539">        return toMillis(y, isLeapYear(y), m, d, h, mi);</span>
    }

    public static long toMillis(int y, boolean leap, int m, int d, int h, int mi) {
<span class="fc" id="L543">        return yearMillis(y, leap) + monthOfYearMillis(m, leap) + (d - 1) * DAY_MILLIS + h * HOUR_MILLIS + mi * MINUTE_MILLIS;</span>
    }

    public static String toString(long millis) {
<span class="fc" id="L547">        StringSink sink = Misc.getThreadLocalBuilder();</span>
<span class="fc" id="L548">        DateFormatUtils.appendDateTime(sink, millis);</span>
<span class="fc" id="L549">        return sink.toString();</span>
    }

    /**
     * Calculated start of year in millis. For example of year 2008 this is
     * equivalent to parsing &quot;2008-01-01T00:00:00.000Z&quot;, except this method is faster.
     *
     * @param year the year
     * @param leap true if give year is leap year
     * @return millis for start of year.
     */
    public static long yearMillis(int year, boolean leap) {
<span class="fc" id="L561">        int leapYears = year / 100;</span>
<span class="fc bfc" id="L562" title="All 2 branches covered.">        if (year &lt; 0) {</span>
<span class="fc" id="L563">            leapYears = ((year + 3) &gt;&gt; 2) - leapYears + ((leapYears + 3) &gt;&gt; 2) - 1;</span>
        } else {
<span class="fc" id="L565">            leapYears = (year &gt;&gt; 2) - leapYears + (leapYears &gt;&gt; 2);</span>
<span class="fc bfc" id="L566" title="All 2 branches covered.">            if (leap) {</span>
<span class="fc" id="L567">                leapYears--;</span>
            }
        }

<span class="fc" id="L571">        return (year * 365L + (leapYears - DAYS_0000_TO_1970)) * DAY_MILLIS;</span>
    }

    private static long getTime(long millis) {
<span class="fc bfc" id="L575" title="All 2 branches covered.">        return millis &lt; 0 ? DAY_MILLIS - 1 + (millis % DAY_MILLIS) : millis % DAY_MILLIS;</span>
    }

    private static boolean isDigit(char c) {
<span class="fc bfc" id="L579" title="All 4 branches covered.">        return c &gt; BEFORE_ZERO &amp;&amp; c &lt; AFTER_NINE;</span>
    }

    private static long toMillis(int y, int m, int d) {
<span class="fc" id="L583">        boolean l = isLeapYear(y);</span>
<span class="fc" id="L584">        return yearMillis(y, l) + monthOfYearMillis(m, l) + (d - 1) * DAY_MILLIS;</span>
    }

    static {
<span class="fc" id="L588">        long minSum = 0;</span>
<span class="fc" id="L589">        long maxSum = 0;</span>
<span class="fc bfc" id="L590" title="All 2 branches covered.">        for (int i = 0; i &lt; 11; i++) {</span>
<span class="fc" id="L591">            minSum += DAYS_PER_MONTH[i] * DAY_MILLIS;</span>
<span class="fc" id="L592">            MIN_MONTH_OF_YEAR_MILLIS[i + 1] = minSum;</span>
<span class="fc" id="L593">            maxSum += getDaysPerMonth(i + 1, true) * DAY_MILLIS;</span>
<span class="fc" id="L594">            MAX_MONTH_OF_YEAR_MILLIS[i + 1] = maxSum;</span>
        }
<span class="fc" id="L596">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>