<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TelemetryConfigLogger.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">io.questdb in questdb Coverage Results</a> &gt; <a href="index.source.html" class="el_package">io.questdb</a> &gt; <span class="el_source">TelemetryConfigLogger.java</span></div><h1>TelemetryConfigLogger.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 *     ___                  _   ____  ____
 *    / _ \ _   _  ___  ___| |_|  _ \| __ )
 *   | | | | | | |/ _ \/ __| __| | | |  _ \
 *   | |_| | |_| |  __/\__ \ |_| |_| | |_) |
 *    \__\_\\__,_|\___||___/\__|____/|____/
 *
 *  Copyright (c) 2014-2019 Appsicle
 *  Copyright (c) 2019-2022 QuestDB
 *
 *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 ******************************************************************************/

package io.questdb;

import io.questdb.cairo.CairoEngine;
import io.questdb.cairo.CairoException;
import io.questdb.cairo.TableToken;
import io.questdb.cairo.TableWriter;
import io.questdb.cairo.security.AllowAllCairoSecurityContext;
import io.questdb.cairo.sql.OperationFuture;
import io.questdb.cairo.sql.Record;
import io.questdb.cairo.sql.RecordCursor;
import io.questdb.cairo.sql.RecordCursorFactory;
import io.questdb.griffin.*;
import io.questdb.log.Log;
import io.questdb.log.LogFactory;
import io.questdb.mp.SCSequence;
import io.questdb.std.Long256;
import io.questdb.std.Misc;
import io.questdb.std.NanosecondClock;
import io.questdb.std.datetime.microtime.MicrosecondClock;

import java.io.Closeable;

public class TelemetryConfigLogger implements Closeable {
<span class="fc" id="L48">    private static final Log LOG = LogFactory.getLog(TelemetryConfigLogger.class);</span>
<span class="fc" id="L49">    public static final CharSequence TELEMETRY_CONFIG_TABLE_NAME = &quot;telemetry_config&quot;;</span>
    static final String OS_NAME = &quot;os.name&quot;;
    static final String QDB_PACKAGE = &quot;QDB_PACKAGE&quot;;

    private final CharSequence questDBVersion;
    private final TelemetryConfiguration telemetryConfiguration;
<span class="fc" id="L55">    private final SCSequence tempSequence = new SCSequence();</span>
    private TableWriter configWriter;

<span class="fc" id="L58">    public TelemetryConfigLogger(CairoEngine engine) {</span>
<span class="fc" id="L59">        questDBVersion = engine.getConfiguration().getBuildInformation().getQuestDbVersion();</span>
<span class="fc" id="L60">        telemetryConfiguration = engine.getConfiguration().getTelemetryConfiguration();</span>
<span class="fc" id="L61">    }</span>

    @Override
    public void close() {
<span class="fc" id="L65">        configWriter = Misc.free(configWriter);</span>
<span class="fc" id="L66">    }</span>

    private void appendConfigRow(SqlCompiler compiler, TableWriter configWriter, Long256 id, boolean enabled) {
<span class="fc" id="L69">        final TableWriter.Row row = configWriter.newRow();</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">        if (id == null) {</span>
<span class="fc" id="L71">            final MicrosecondClock clock = compiler.getEngine().getConfiguration().getMicrosecondClock();</span>
<span class="fc" id="L72">            final NanosecondClock nanosecondClock = compiler.getEngine().getConfiguration().getNanosecondClock();</span>
<span class="fc" id="L73">            final long a = nanosecondClock.getTicks();</span>
<span class="fc" id="L74">            final long b = clock.getTicks();</span>
<span class="fc" id="L75">            row.putLong256(0, a, b, 0, 0);</span>
<span class="fc" id="L76">            LOG.info()</span>
<span class="fc" id="L77">                    .$(&quot;new instance [id=&quot;).$256(a, b, 0, 0)</span>
<span class="fc" id="L78">                    .$(&quot;, enabled=&quot;).$(enabled)</span>
<span class="fc" id="L79">                    .$(']').$();</span>
<span class="fc" id="L80">        } else {</span>
<span class="fc" id="L81">            row.putLong256(0, id);</span>
        }
<span class="fc" id="L83">        row.putBool(1, enabled);</span>
<span class="fc" id="L84">        row.putSym(2, questDBVersion);</span>
<span class="fc" id="L85">        row.putSym(3, System.getProperty(OS_NAME));</span>
<span class="fc" id="L86">        final String packageStr = System.getenv().get(QDB_PACKAGE);</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">        if (packageStr != null) {</span>
<span class="nc" id="L88">            row.putSym(4, packageStr);</span>
        }
<span class="fc" id="L90">        row.append();</span>
<span class="fc" id="L91">        configWriter.commit();</span>
<span class="fc" id="L92">    }</span>

    private void tryAddColumn(SqlCompiler compiler, SqlExecutionContext executionContext, CharSequence columnDetails) {
        try {
<span class="fc" id="L96">            final CompiledQuery cc = compiler.compile(</span>
                    &quot;ALTER TABLE &quot; + TELEMETRY_CONFIG_TABLE_NAME + &quot; ADD COLUMN &quot; + columnDetails,
                    executionContext
            );
<span class="fc" id="L100">            try (OperationFuture fut = cc.execute(tempSequence)) {</span>
<span class="fc" id="L101">                fut.await();</span>
            }
<span class="fc" id="L103">        } catch (SqlException ex) {</span>
<span class="fc" id="L104">            LOG.info().$(&quot;Failed to alter telemetry table [table=&quot;).$(TELEMETRY_CONFIG_TABLE_NAME).$(&quot;, error=&quot;).$(ex.getFlyweightMessage()).I$();</span>
<span class="fc" id="L105">        }</span>
<span class="fc" id="L106">    }</span>

    private TableWriter updateTelemetryConfig(
            SqlCompiler compiler,
            SqlExecutionContextImpl sqlExecutionContext,
            TableToken tableToken
    ) throws SqlException {
<span class="fc" id="L113">        final TableWriter configWriter = compiler.getEngine().getWriter(AllowAllCairoSecurityContext.INSTANCE, tableToken, &quot;telemetryConfig&quot;);</span>
<span class="fc" id="L114">        final CompiledQuery cc = compiler.compile(TELEMETRY_CONFIG_TABLE_NAME + &quot; LIMIT -1&quot;, sqlExecutionContext);</span>
        try (
<span class="fc" id="L116">                final RecordCursorFactory factory = cc.getRecordCursorFactory();</span>
<span class="fc" id="L117">                final RecordCursor cursor = factory.getCursor(sqlExecutionContext)</span>
        ) {
<span class="fc" id="L119">            final boolean enabled = telemetryConfiguration.getEnabled();</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">            if (cursor.hasNext()) {</span>
<span class="fc" id="L121">                final Record record = cursor.getRecord();</span>
<span class="fc" id="L122">                final boolean _enabled = record.getBool(1);</span>
<span class="fc" id="L123">                final Long256 l256 = record.getLong256A(0);</span>
<span class="fc" id="L124">                final CharSequence _questDBVersion = record.getSym(2);</span>

                // if the configuration changed to enable or disable telemetry
                // we need to update the table to reflect that
<span class="pc bpc" id="L128" title="1 of 4 branches missed.">                if (enabled != _enabled || !questDBVersion.equals(_questDBVersion)) {</span>
<span class="fc" id="L129">                    appendConfigRow(compiler, configWriter, l256, enabled);</span>
<span class="fc" id="L130">                    LOG.advisory()</span>
<span class="fc" id="L131">                            .$(&quot;instance config changes [id=&quot;).$256(l256.getLong0(), l256.getLong1(), 0, 0)</span>
<span class="fc" id="L132">                            .$(&quot;, enabled=&quot;).$(enabled)</span>
<span class="fc" id="L133">                            .$(']').$();</span>
                } else {
<span class="fc" id="L135">                    LOG.advisory()</span>
<span class="fc" id="L136">                            .$(&quot;instance [id=&quot;).$256(l256.getLong0(), l256.getLong1(), 0, 0)</span>
<span class="fc" id="L137">                            .$(&quot;, enabled=&quot;).$(enabled)</span>
<span class="fc" id="L138">                            .$(']').$();</span>
                }
<span class="fc" id="L140">            } else {</span>
                // if there are no record for telemetry id we need to create one using clocks
<span class="fc" id="L142">                appendConfigRow(compiler, configWriter, null, enabled);</span>
            }
        }
<span class="fc" id="L145">        return configWriter;</span>
    }

    void init(CairoEngine engine, SqlCompiler compiler, SqlExecutionContextImpl sqlExecutionContext) throws SqlException {
<span class="fc" id="L149">        compiler.compile(&quot;CREATE TABLE IF NOT EXISTS &quot; + TELEMETRY_CONFIG_TABLE_NAME + &quot; (id long256, enabled boolean, version symbol, os symbol, package symbol)&quot;, sqlExecutionContext);</span>
<span class="fc" id="L150">        tryAddColumn(compiler, sqlExecutionContext, &quot;version symbol&quot;);</span>
<span class="fc" id="L151">        tryAddColumn(compiler, sqlExecutionContext, &quot;os symbol&quot;);</span>
<span class="fc" id="L152">        tryAddColumn(compiler, sqlExecutionContext, &quot;package symbol&quot;);</span>

        // TODO: close configWriter, we currently keep it open to prevent users from modifying the table.
        // Once we have a permission system, we can use that instead.
        try {
<span class="fc" id="L157">            final TableToken configTableToken = engine.getTableToken(TELEMETRY_CONFIG_TABLE_NAME);</span>
<span class="fc" id="L158">            configWriter = updateTelemetryConfig(compiler, sqlExecutionContext, configTableToken);</span>
<span class="nc" id="L159">        } catch (CairoException ex) {</span>
<span class="nc" id="L160">            LOG.error()</span>
<span class="nc" id="L161">                    .$(&quot;could not open [table=`&quot;).utf8(TELEMETRY_CONFIG_TABLE_NAME)</span>
<span class="nc" id="L162">                    .$(&quot;`, ex=&quot;).$(ex.getFlyweightMessage())</span>
<span class="nc" id="L163">                    .$(&quot;, errno=&quot;).$(ex.getErrno())</span>
<span class="nc" id="L164">                    .$(']').$();</span>
<span class="fc" id="L165">        }</span>
<span class="fc" id="L166">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>