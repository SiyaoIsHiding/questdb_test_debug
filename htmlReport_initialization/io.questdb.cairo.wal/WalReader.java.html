<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WalReader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">io.questdb in questdb Coverage Results</a> &gt; <a href="index.source.html" class="el_package">io.questdb.cairo.wal</a> &gt; <span class="el_source">WalReader.java</span></div><h1>WalReader.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 *     ___                  _   ____  ____
 *    / _ \ _   _  ___  ___| |_|  _ \| __ )
 *   | | | | | | |/ _ \/ __| __| | | |  _ \
 *   | |_| | |_| |  __/\__ \ |_| |_| | |_) |
 *    \__\_\\__,_|\___||___/\__|____/|____/
 *
 *  Copyright (c) 2014-2019 Appsicle
 *  Copyright (c) 2019-2022 QuestDB
 *
 *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 ******************************************************************************/

package io.questdb.cairo.wal;

import io.questdb.cairo.*;
import io.questdb.cairo.vm.NullMemoryMR;
import io.questdb.cairo.vm.Vm;
import io.questdb.cairo.vm.api.MemoryMR;
import io.questdb.cairo.vm.api.MemoryR;
import io.questdb.cairo.wal.seq.SequencerMetadata;
import io.questdb.log.Log;
import io.questdb.log.LogFactory;
import io.questdb.std.*;
import io.questdb.std.str.Path;
import org.jetbrains.annotations.NotNull;

import java.io.Closeable;

import static io.questdb.cairo.TableUtils.COLUMN_NAME_TXN_NONE;
import static io.questdb.cairo.wal.WalTxnType.DATA;
import static io.questdb.cairo.wal.WalUtils.WAL_FORMAT_VERSION;

public class WalReader implements Closeable {
<span class="fc" id="L46">    private static final Log LOG = LogFactory.getLog(WalReader.class);</span>
    private final int columnCount;
    private final ObjList&lt;MemoryMR&gt; columns;
<span class="fc" id="L49">    private final WalDataCursor dataCursor = new WalDataCursor();</span>
    private final WalEventCursor eventCursor;
    private final WalEventReader events;
    private final FilesFacade ff;
    private final SequencerMetadata metadata;
    private final Path path;
    private final int rootLen;
    private final long rowCount;
<span class="fc" id="L57">    private final ObjList&lt;IntObjHashMap&lt;CharSequence&gt;&gt; symbolMaps = new ObjList&lt;&gt;();</span>
    private final String tableName;
    private final String walName;

<span class="fc" id="L61">    public WalReader(CairoConfiguration configuration, TableToken tableToken, CharSequence walName, int segmentId, long rowCount) {</span>
<span class="fc" id="L62">        this.tableName = tableToken.getTableName();</span>
<span class="fc" id="L63">        this.walName = Chars.toString(walName);</span>
<span class="fc" id="L64">        this.rowCount = rowCount;</span>

<span class="fc" id="L66">        ff = configuration.getFilesFacade();</span>
<span class="fc" id="L67">        path = new Path();</span>
<span class="fc" id="L68">        path.of(configuration.getRoot()).concat(tableToken.getDirName()).concat(walName);</span>
<span class="fc" id="L69">        rootLen = path.length();</span>

        try {
<span class="fc" id="L72">            metadata = new SequencerMetadata(ff, true);</span>
<span class="fc" id="L73">            metadata.open(path.slash().put(segmentId), rootLen);</span>
<span class="fc" id="L74">            columnCount = metadata.getColumnCount();</span>
<span class="fc" id="L75">            events = new WalEventReader(ff);</span>
<span class="fc" id="L76">            LOG.debug().$(&quot;open [table=&quot;).$(tableName).I$();</span>
<span class="fc" id="L77">            int pathLen = path.length();</span>
<span class="fc" id="L78">            eventCursor = events.of(path.slash().put(segmentId), WAL_FORMAT_VERSION, -1L);</span>
<span class="fc" id="L79">            path.trimTo(pathLen);</span>
<span class="fc" id="L80">            openSymbolMaps(eventCursor, configuration);</span>
<span class="fc" id="L81">            path.slash().put(segmentId);</span>
<span class="fc" id="L82">            eventCursor.reset();</span>

<span class="fc" id="L84">            final int capacity = 2 * columnCount + 2;</span>
<span class="fc" id="L85">            columns = new ObjList&lt;&gt;(capacity);</span>
<span class="fc" id="L86">            columns.setPos(capacity + 2);</span>
<span class="fc" id="L87">            columns.setQuick(0, NullMemoryMR.INSTANCE);</span>
<span class="fc" id="L88">            columns.setQuick(1, NullMemoryMR.INSTANCE);</span>
<span class="fc" id="L89">            dataCursor.of(this);</span>
<span class="fc" id="L90">        } catch (Throwable e) {</span>
<span class="fc" id="L91">            close();</span>
<span class="fc" id="L92">            throw e;</span>
<span class="fc" id="L93">        }</span>
<span class="fc" id="L94">    }</span>

    @Override
    public void close() {
<span class="fc" id="L98">        Misc.free(events);</span>
<span class="fc" id="L99">        Misc.free(metadata);</span>
<span class="fc" id="L100">        Misc.freeObjList(columns);</span>
<span class="fc" id="L101">        Misc.free(path);</span>
<span class="fc" id="L102">        LOG.debug().$(&quot;closed '&quot;).utf8(tableName).$('\'').$();</span>
<span class="fc" id="L103">    }</span>

    public MemoryR getColumn(int absoluteIndex) {
<span class="fc" id="L106">        return columns.getQuick(absoluteIndex);</span>
    }

    public String getColumnName(int columnIndex) {
<span class="fc" id="L110">        return metadata.getColumnName(columnIndex);</span>
    }

    public int getColumnType(int columnIndex) {
<span class="fc" id="L114">        return metadata.getColumnType(columnIndex);</span>
    }

    public WalDataCursor getDataCursor() {
<span class="fc" id="L118">        dataCursor.toTop();</span>
<span class="fc" id="L119">        return dataCursor;</span>
    }

    public WalEventCursor getEventCursor() {
<span class="fc" id="L123">        return eventCursor;</span>
    }

    public CharSequence getSymbolValue(int col, int key) {
<span class="fc" id="L127">        IntObjHashMap&lt;CharSequence&gt; symbolMap = symbolMaps.getQuick(col);</span>
<span class="fc" id="L128">        return symbolMap.get(key);</span>
    }

    public String getTableName() {
<span class="fc" id="L132">        return tableName;</span>
    }

    public int getTimestampIndex() {
<span class="fc" id="L136">        return metadata.getTimestampIndex();</span>
    }

    public String getWalName() {
<span class="fc" id="L140">        return walName;</span>
    }

    public long openSegment() {
        try {
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">            if (ff.exists(path.$())) {</span>
<span class="fc" id="L146">                openSegmentColumns();</span>
<span class="fc" id="L147">                return rowCount;</span>
            }
<span class="nc" id="L149">            LOG.error().$(&quot;open segment failed, segment does not exist on the disk. [path=&quot;).utf8(path.$()).I$();</span>
<span class="nc" id="L150">            throw CairoException.critical(0)</span>
<span class="nc" id="L151">                    .put(&quot;WAL data directory does not exist on disk at &quot;)</span>
<span class="nc" id="L152">                    .put(path);</span>
        } finally {
<span class="fc" id="L154">            path.trimTo(rootLen);</span>
        }
    }

    public long size() {
<span class="fc" id="L159">        return rowCount;</span>
    }

    private void loadColumnAt(int columnIndex) {
<span class="fc" id="L163">        final int pathLen = path.length();</span>
        try {
<span class="fc" id="L165">            final int columnType = metadata.getColumnType(columnIndex);</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">            if (columnType &gt; 0) {</span>
<span class="fc" id="L167">                final CharSequence name = metadata.getColumnName(columnIndex);</span>
<span class="fc" id="L168">                final int primaryIndex = getPrimaryColumnIndex(columnIndex);</span>
<span class="fc" id="L169">                final int secondaryIndex = primaryIndex + 1;</span>
<span class="fc" id="L170">                final MemoryMR primaryMem = columns.getQuick(primaryIndex);</span>

<span class="fc bfc" id="L172" title="All 2 branches covered.">                if (ColumnType.isVariableLength(columnType)) {</span>
<span class="fc" id="L173">                    long columnSize = (rowCount + 1) &lt;&lt; 3;</span>
<span class="fc" id="L174">                    TableUtils.iFile(path.trimTo(pathLen), name);</span>
<span class="fc" id="L175">                    MemoryMR secondaryMem = columns.getQuick(secondaryIndex);</span>
<span class="fc" id="L176">                    secondaryMem = openOrCreateMemory(path, columns, secondaryIndex, secondaryMem, columnSize);</span>
<span class="fc" id="L177">                    columnSize = secondaryMem.getLong(rowCount &lt;&lt; 3);</span>
<span class="fc" id="L178">                    TableUtils.dFile(path.trimTo(pathLen), name);</span>
<span class="fc" id="L179">                    openOrCreateMemory(path, columns, primaryIndex, primaryMem, columnSize);</span>
<span class="fc" id="L180">                } else {</span>
<span class="fc" id="L181">                    long columnSize = rowCount &lt;&lt; ColumnType.pow2SizeOf(columnType);</span>
<span class="fc" id="L182">                    TableUtils.dFile(path.trimTo(pathLen), name);</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">                    openOrCreateMemory(path, columns, primaryIndex, primaryMem, columnIndex == getTimestampIndex() ? columnSize &lt;&lt; 1 : columnSize);</span>
<span class="fc" id="L184">                    Misc.free(columns.getAndSetQuick(secondaryIndex, null));</span>
                }
            }
        } finally {
<span class="fc" id="L188">            path.trimTo(pathLen);</span>
        }
<span class="fc" id="L190">    }</span>

    @NotNull
    private MemoryMR openOrCreateMemory(
            Path path,
            ObjList&lt;MemoryMR&gt; columns,
            int primaryIndex,
            MemoryMR mem,
            long columnSize
    ) {
<span class="pc bpc" id="L200" title="3 of 4 branches missed.">        if (mem != null &amp;&amp; mem != NullMemoryMR.INSTANCE) {</span>
<span class="nc" id="L201">            mem.of(ff, path, columnSize, columnSize, MemoryTag.MMAP_TABLE_WAL_READER);</span>
        } else {
<span class="fc" id="L203">            mem = Vm.getMRInstance(ff, path, columnSize, MemoryTag.MMAP_TABLE_WAL_READER);</span>
<span class="fc" id="L204">            columns.setQuick(primaryIndex, mem);</span>
        }
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">        return mem;</span>
    }

    private void openSegmentColumns() {
<span class="fc bfc" id="L210" title="All 2 branches covered.">        for (int i = 0; i &lt; columnCount; i++) {</span>
<span class="fc" id="L211">            loadColumnAt(i);</span>
        }
<span class="fc" id="L213">    }</span>

    private void openSymbolMaps(WalEventCursor eventCursor, CairoConfiguration configuration) {
<span class="fc bfc" id="L216" title="All 2 branches covered.">        while (eventCursor.hasNext()) {</span>
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">            if (eventCursor.getType() == DATA) {</span>
<span class="fc" id="L218">                WalEventCursor.DataInfo dataInfo = eventCursor.getDataInfo();</span>
<span class="fc" id="L219">                SymbolMapDiff symbolDiff = dataInfo.nextSymbolMapDiff();</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">                while (symbolDiff != null) {</span>
<span class="fc" id="L221">                    int cleanSymbolCount = symbolDiff.getCleanSymbolCount();</span>
<span class="fc" id="L222">                    int columnIndex = symbolDiff.getColumnIndex();</span>
                    final IntObjHashMap&lt;CharSequence&gt; symbolMap;

<span class="pc bpc" id="L225" title="3 of 4 branches missed.">                    if (symbolMaps.size() &lt;= columnIndex || symbolMaps.getQuick(columnIndex) == null) {</span>
<span class="fc" id="L226">                        symbolMap = new IntObjHashMap&lt;&gt;();</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">                        if (cleanSymbolCount &gt; 0) {</span>
                            try (
<span class="fc" id="L229">                                    SymbolMapReaderImpl symbolMapReader = new SymbolMapReaderImpl(</span>
                                            configuration,
                                            path,
<span class="fc" id="L232">                                            this.metadata.getColumnName(columnIndex),</span>
                                            COLUMN_NAME_TXN_NONE,
                                            cleanSymbolCount
                                    )
                            ) {
<span class="fc bfc" id="L237" title="All 2 branches covered.">                                for (int key = 0; key &lt; cleanSymbolCount; key++) {</span>
<span class="fc" id="L238">                                    CharSequence symbol = symbolMapReader.valueOf(key);</span>
<span class="fc" id="L239">                                    symbolMap.put(key, String.valueOf(symbol));</span>
                                }
                            }
                        }
<span class="fc" id="L243">                        symbolMaps.extendAndSet(columnIndex, symbolMap);</span>
                    } else {
<span class="nc" id="L245">                        symbolMap = symbolMaps.getQuick(columnIndex);</span>
                    }

<span class="fc" id="L248">                    SymbolMapDiffEntry entry = symbolDiff.nextEntry();</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">                    while (entry != null) {</span>
<span class="fc" id="L250">                        symbolMap.put(entry.getKey(), String.valueOf(entry.getSymbol()));</span>
<span class="fc" id="L251">                        entry = symbolDiff.nextEntry();</span>
                    }

<span class="fc" id="L254">                    symbolDiff = dataInfo.nextSymbolMapDiff();</span>
<span class="fc" id="L255">                }</span>
<span class="fc" id="L256">            }</span>
        }
<span class="fc" id="L258">    }</span>

    static int getPrimaryColumnIndex(int index) {
<span class="fc" id="L261">        return index * 2 + 2;</span>
    }

    int getColumnCount() {
<span class="fc" id="L265">        return columnCount;</span>
    }

    int getRealColumnCount() {
<span class="fc" id="L269">        return metadata.getRealColumnCount();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>