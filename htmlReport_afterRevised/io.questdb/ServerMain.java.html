<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServerMain.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">All in questdb Coverage Results</a> &gt; <a href="index.source.html" class="el_package">io.questdb</a> &gt; <span class="el_source">ServerMain.java</span></div><h1>ServerMain.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 *     ___                  _   ____  ____
 *    / _ \ _   _  ___  ___| |_|  _ \| __ )
 *   | | | | | | |/ _ \/ __| __| | | |  _ \
 *   | |_| | |_| |  __/\__ \ |_| |_| | |_) |
 *    \__\_\\__,_|\___||___/\__|____/|____/
 *
 *  Copyright (c) 2014-2019 Appsicle
 *  Copyright (c) 2019-2022 QuestDB
 *
 *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 ******************************************************************************/

package io.questdb;

import io.questdb.cairo.CairoConfiguration;
import io.questdb.cairo.CairoEngine;
import io.questdb.cairo.ColumnIndexerJob;
import io.questdb.cairo.O3Utils;
import io.questdb.cairo.wal.ApplyWal2TableJob;
import io.questdb.cairo.wal.CheckWalTransactionsJob;
import io.questdb.cairo.wal.WalPurgeJob;
import io.questdb.cutlass.Services;
import io.questdb.cutlass.text.TextImportJob;
import io.questdb.cutlass.text.TextImportRequestJob;
import io.questdb.griffin.DatabaseSnapshotAgent;
import io.questdb.griffin.FunctionFactory;
import io.questdb.griffin.FunctionFactoryCache;
import io.questdb.griffin.engine.groupby.vect.GroupByJob;
import io.questdb.griffin.engine.table.AsyncFilterAtom;
import io.questdb.griffin.engine.table.LatestByAllIndexedJob;
import io.questdb.log.Log;
import io.questdb.log.LogFactory;
import io.questdb.mp.WorkerPool;
import io.questdb.std.Misc;
import io.questdb.std.ObjList;
import org.jetbrains.annotations.Nullable;

import java.io.Closeable;
import java.util.ServiceLoader;
import java.util.concurrent.atomic.AtomicBoolean;

public class ServerMain implements Closeable {
    private final String banner;
<span class="fc" id="L56">    private final AtomicBoolean closed = new AtomicBoolean();</span>
    private final PropServerConfiguration config;
    private final CairoEngine engine;
    private final FunctionFactoryCache ffCache;
<span class="fc" id="L60">    private final ObjList&lt;Closeable&gt; freeOnExitList = new ObjList&lt;&gt;();</span>
    private final Log log;
<span class="fc" id="L62">    private final AtomicBoolean running = new AtomicBoolean();</span>
    private final WorkerPoolManager workerPoolManager;

    public ServerMain(String... args) {
<span class="fc" id="L66">        this(new Bootstrap(args));</span>
<span class="fc" id="L67">    }</span>

    public ServerMain(final Bootstrap bootstrap) {
<span class="fc" id="L70">        this(bootstrap.getConfiguration(), bootstrap.getMetrics(), bootstrap.getLog(), bootstrap.getBanner());</span>
<span class="fc" id="L71">    }</span>

<span class="fc" id="L73">    public ServerMain(final PropServerConfiguration config, final Metrics metrics, final Log log, String banner) {</span>
<span class="fc" id="L74">        this.config = config;</span>
<span class="fc" id="L75">        this.log = log;</span>
<span class="fc" id="L76">        this.banner = banner;</span>

        // create cairo engine
<span class="fc" id="L79">        final CairoConfiguration cairoConfig = config.getCairoConfiguration();</span>
<span class="fc" id="L80">        engine = freeOnExit(new CairoEngine(cairoConfig, metrics));</span>

        // create function factory cache
<span class="fc" id="L83">        ffCache = new FunctionFactoryCache(</span>
                cairoConfig,
<span class="fc" id="L85">                ServiceLoader.load(FunctionFactory.class, FunctionFactory.class.getClassLoader())</span>
        );

        // snapshots
<span class="fc" id="L89">        final DatabaseSnapshotAgent snapshotAgent = freeOnExit(new DatabaseSnapshotAgent(engine));</span>

        // create the worker pool manager, and configure the shared pool
<span class="fc" id="L92">        final boolean walSupported = config.getCairoConfiguration().isWalSupported();</span>
<span class="fc" id="L93">        final boolean isReadOnly = config.getCairoConfiguration().isReadOnlyInstance();</span>
<span class="fc" id="L94">        workerPoolManager = new WorkerPoolManager(config, metrics.health()) {</span>
            @Override
            protected void configureSharedPool(WorkerPool sharedPool) {
                try {
<span class="fc" id="L98">                    sharedPool.assign(engine.getEngineMaintenanceJob());</span>

<span class="fc" id="L100">                    final MessageBus messageBus = engine.getMessageBus();</span>
                    // register jobs that help parallel execution of queries and column indexing.
<span class="fc" id="L102">                    sharedPool.assign(new ColumnIndexerJob(messageBus));</span>
<span class="fc" id="L103">                    sharedPool.assign(new GroupByJob(messageBus));</span>
<span class="fc" id="L104">                    sharedPool.assign(new LatestByAllIndexedJob(messageBus));</span>

<span class="pc bpc" id="L106" title="1 of 2 branches missed.">                    if (!isReadOnly) {</span>
<span class="fc" id="L107">                        O3Utils.setupWorkerPool(</span>
                                sharedPool,
                                engine,
<span class="fc" id="L110">                                config.getCairoConfiguration().getCircuitBreakerConfiguration(),</span>
                                ffCache
                        );

<span class="pc bpc" id="L114" title="1 of 2 branches missed.">                        if (walSupported) {</span>
<span class="fc" id="L115">                            sharedPool.assign(new CheckWalTransactionsJob(engine));</span>
<span class="fc" id="L116">                            final WalPurgeJob walPurgeJob = new WalPurgeJob(engine);</span>
<span class="fc" id="L117">                            snapshotAgent.setWalPurgeJobRunLock(walPurgeJob.getRunLock());</span>
<span class="fc" id="L118">                            walPurgeJob.delayByHalfInterval();</span>
<span class="fc" id="L119">                            sharedPool.assign(walPurgeJob);</span>
<span class="fc" id="L120">                            sharedPool.freeOnExit(walPurgeJob);</span>

<span class="pc bpc" id="L122" title="1 of 2 branches missed.">                            if (!config.getWalApplyPoolConfiguration().isEnabled()) {</span>
<span class="nc" id="L123">                                setupWalApplyJob(sharedPool, engine, getSharedWorkerCount(), ffCache);</span>
                            }
                        }

                        // text import
<span class="fc" id="L128">                        TextImportJob.assignToPool(messageBus, sharedPool);</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">                        if (cairoConfig.getSqlCopyInputRoot() != null) {</span>
<span class="nc" id="L130">                            final TextImportRequestJob textImportRequestJob = new TextImportRequestJob(</span>
                                    engine,
                                    // save CPU resources for collecting and processing jobs
<span class="nc" id="L133">                                    Math.max(1, sharedPool.getWorkerCount() - 2),</span>
                                    ffCache
                            );
<span class="nc" id="L136">                            sharedPool.assign(textImportRequestJob);</span>
<span class="nc" id="L137">                            sharedPool.freeOnExit(textImportRequestJob);</span>
                        }
                    }

                    // telemetry
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">                    if (!cairoConfig.getTelemetryConfiguration().getDisableCompletely()) {</span>
<span class="fc" id="L143">                        final TelemetryJob telemetryJob = new TelemetryJob(engine, ffCache);</span>
<span class="fc" id="L144">                        freeOnExitList.add(telemetryJob);</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">                        if (cairoConfig.getTelemetryConfiguration().getEnabled()) {</span>
<span class="nc" id="L146">                            sharedPool.assign(telemetryJob);</span>
                        }
                    }
<span class="nc" id="L149">                } catch (Throwable thr) {</span>
<span class="nc" id="L150">                    throw new Bootstrap.BootstrapException(thr);</span>
<span class="fc" id="L151">                }</span>
<span class="fc" id="L152">            }</span>
        };

<span class="pc bpc" id="L155" title="3 of 6 branches missed.">        if (!isReadOnly &amp;&amp; walSupported &amp;&amp; config.getWalApplyPoolConfiguration().isEnabled()) {</span>
<span class="fc" id="L156">            WorkerPool walApplyWorkerPool = workerPoolManager.getInstance(</span>
<span class="fc" id="L157">                    config.getWalApplyPoolConfiguration(),</span>
<span class="fc" id="L158">                    metrics.health(),</span>
                    WorkerPoolManager.Requester.WAL_APPLY
            );
<span class="fc" id="L161">            setupWalApplyJob(walApplyWorkerPool, engine, workerPoolManager.getSharedWorkerCount(), ffCache);</span>
        }

        // http
<span class="fc" id="L165">        freeOnExit(Services.createHttpServer(</span>
<span class="fc" id="L166">                config.getHttpServerConfiguration(),</span>
                engine,
                workerPoolManager,
                ffCache,
                snapshotAgent,
                metrics
        ));

        // http min
<span class="fc" id="L175">        freeOnExit(Services.createMinHttpServer(</span>
<span class="fc" id="L176">                config.getHttpMinServerConfiguration(),</span>
                engine,
                workerPoolManager,
                metrics
        ));

        // pg wire
<span class="fc" id="L183">        freeOnExit(Services.createPGWireServer(</span>
<span class="fc" id="L184">                config.getPGWireConfiguration(),</span>
                engine,
                workerPoolManager,
                ffCache,
                snapshotAgent,
                metrics
        ));

<span class="pc bpc" id="L192" title="1 of 2 branches missed.">        if (!isReadOnly) {</span>
            // ilp/tcp
<span class="fc" id="L194">            freeOnExit(Services.createLineTcpReceiver(</span>
<span class="fc" id="L195">                    config.getLineTcpReceiverConfiguration(),</span>
                    engine,
                    workerPoolManager,
                    metrics
            ));

            // ilp/udp
<span class="fc" id="L202">            freeOnExit(Services.createLineUdpReceiver(</span>
<span class="fc" id="L203">                    config.getLineUdpReceiverConfiguration(),</span>
                    engine,
                    workerPoolManager
            ));
        }

<span class="fc" id="L209">        System.gc(); // GC 1</span>
<span class="fc" id="L210">        log.advisoryW().$(&quot;bootstrap complete&quot;).$();</span>
<span class="fc" id="L211">    }</span>

    protected void setupWalApplyJob(
            WorkerPool workerPool,
            CairoEngine engine,
            int sharedWorkerCount,
            @Nullable FunctionFactoryCache ffCache
    ) {
<span class="fc bfc" id="L219" title="All 2 branches covered.">        for (int i = 0, workerCount = workerPool.getWorkerCount(); i &lt; workerCount; i++) {</span>
            // create job per worker
<span class="fc" id="L221">            final ApplyWal2TableJob applyWal2TableJob = new ApplyWal2TableJob(engine, workerCount, sharedWorkerCount, ffCache);</span>
<span class="fc" id="L222">            workerPool.assign(i, applyWal2TableJob);</span>
<span class="fc" id="L223">            workerPool.freeOnExit(applyWal2TableJob);</span>
        }
<span class="fc" id="L225">    }</span>

    public static void main(String[] args) {
        try {
<span class="nc" id="L229">            new ServerMain(args).start(true);</span>
<span class="nc" id="L230">        } catch (Throwable thr) {</span>
<span class="nc" id="L231">            thr.printStackTrace();</span>
<span class="nc" id="L232">            LogFactory.closeInstance();</span>
<span class="nc" id="L233">            System.exit(55);</span>
<span class="nc" id="L234">        }</span>
<span class="nc" id="L235">    }</span>

    @Override
    public void close() {
<span class="fc bfc" id="L239" title="All 2 branches covered.">        if (closed.compareAndSet(false, true)) {</span>
<span class="fc" id="L240">            workerPoolManager.halt();</span>
            // free instances in reverse order to which we allocated them
<span class="fc bfc" id="L242" title="All 2 branches covered.">            for (int i = freeOnExitList.size() - 1; i &gt;= 0; i--) {</span>
<span class="fc" id="L243">                Misc.free(freeOnExitList.getQuick(i));</span>
            }
<span class="fc" id="L245">            freeOnExitList.clear();</span>
        }
<span class="fc" id="L247">    }</span>

    public CairoEngine getCairoEngine() {
<span class="fc bfc" id="L250" title="All 2 branches covered.">        if (closed.get()) {</span>
<span class="fc" id="L251">            throw new IllegalStateException(&quot;close was called&quot;);</span>
        }
<span class="fc" id="L253">        return engine;</span>
    }

    public PropServerConfiguration getConfiguration() {
<span class="fc" id="L257">        return config;</span>
    }

    public WorkerPoolManager getWorkerPoolManager() {
<span class="fc bfc" id="L261" title="All 2 branches covered.">        if (closed.get()) {</span>
<span class="fc" id="L262">            throw new IllegalStateException(&quot;close was called&quot;);</span>
        }
<span class="fc" id="L264">        return workerPoolManager;</span>
    }

    public boolean hasBeenClosed() {
<span class="fc" id="L268">        return closed.get();</span>
    }

    public boolean hasStarted() {
<span class="fc" id="L272">        return running.get();</span>
    }

    public void start() {
<span class="fc" id="L276">        start(false);</span>
<span class="fc" id="L277">    }</span>

    public void start(boolean addShutdownHook) {
<span class="fc bfc" id="L280" title="All 4 branches covered.">        if (!closed.get() &amp;&amp; running.compareAndSet(false, true)) {</span>
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">            if (addShutdownHook) {</span>
<span class="nc" id="L282">                addShutdownHook();</span>
            }
<span class="fc" id="L284">            workerPoolManager.start(log);</span>
<span class="fc" id="L285">            Bootstrap.logWebConsoleUrls(config, log, banner);</span>
<span class="fc" id="L286">            System.gc(); // final GC</span>
<span class="fc" id="L287">            log.advisoryW().$(&quot;enjoy&quot;).$();</span>
        }
<span class="fc" id="L289">    }</span>

    private void addShutdownHook() {
<span class="nc" id="L292">        Runtime.getRuntime().addShutdownHook(new Thread(() -&gt; {</span>
            try {
<span class="nc" id="L294">                System.err.println(&quot;QuestDB is shutting down...&quot;);</span>
<span class="nc" id="L295">                System.err.println(&quot;Pre-touch magic number: &quot; + AsyncFilterAtom.PRE_TOUCH_BLACK_HOLE.sum());</span>
<span class="nc" id="L296">                close();</span>
<span class="nc" id="L297">                LogFactory.closeInstance();</span>
<span class="nc" id="L298">            } catch (Error ignore) {</span>
                // ignore
            } finally {
<span class="nc" id="L301">                System.err.println(&quot;QuestDB is shutdown.&quot;);</span>
            }
<span class="nc" id="L303">        }));</span>
<span class="nc" id="L304">    }</span>

    private &lt;T extends Closeable&gt; T freeOnExit(T closeable) {
<span class="fc bfc" id="L307" title="All 2 branches covered.">        if (closeable != null) {</span>
<span class="fc" id="L308">            freeOnExitList.add(closeable);</span>
        }
<span class="fc" id="L310">        return closeable;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>