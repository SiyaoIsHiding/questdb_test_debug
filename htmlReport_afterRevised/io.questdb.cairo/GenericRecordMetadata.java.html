<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GenericRecordMetadata.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">All in questdb Coverage Results</a> &gt; <a href="index.source.html" class="el_package">io.questdb.cairo</a> &gt; <span class="el_source">GenericRecordMetadata.java</span></div><h1>GenericRecordMetadata.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 *     ___                  _   ____  ____
 *    / _ \ _   _  ___  ___| |_|  _ \| __ )
 *   | | | | | | |/ _ \/ __| __| | | |  _ \
 *   | |_| | |_| |  __/\__ \ |_| |_| | |_) |
 *    \__\_\\__,_|\___||___/\__|____/|____/
 *
 *  Copyright (c) 2014-2019 Appsicle
 *  Copyright (c) 2019-2022 QuestDB
 *
 *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 ******************************************************************************/

package io.questdb.cairo;

import io.questdb.cairo.sql.ColumnMetadataCollection;
import io.questdb.cairo.sql.RecordMetadata;
import io.questdb.cairo.sql.TableRecordMetadata;

<span class="fc" id="L31">public class GenericRecordMetadata extends AbstractRecordMetadata {</span>

    public static void copyColumns(RecordMetadata from, GenericRecordMetadata to) {
<span class="pc bpc" id="L34" title="1 of 2 branches missed.">        if (from instanceof AbstractRecordMetadata) {</span>
<span class="fc" id="L35">            final AbstractRecordMetadata gm = (AbstractRecordMetadata) from;</span>
<span class="fc bfc" id="L36" title="All 2 branches covered.">            for (int i = 0, n = gm.getColumnCount(); i &lt; n; i++) {</span>
<span class="fc" id="L37">                to.add(gm.getColumnMetadata(i));</span>
            }
<span class="fc" id="L39">        } else {</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">            for (int i = 0, n = from.getColumnCount(); i &lt; n; i++) {</span>
<span class="nc" id="L41">                to.add(new TableColumnMetadata(</span>
<span class="nc" id="L42">                        from.getColumnName(i),</span>
<span class="nc" id="L43">                        from.getColumnType(i),</span>
<span class="nc" id="L44">                        from.isColumnIndexed(i),</span>
<span class="nc" id="L45">                        from.getIndexValueBlockCapacity(i),</span>
<span class="nc" id="L46">                        from.isSymbolTableStatic(i),</span>
<span class="nc" id="L47">                        GenericRecordMetadata.copyOf(from.getMetadata(i))</span>
                ));
            }
        }
<span class="fc" id="L51">    }</span>

    public static GenericRecordMetadata copyDense(TableRecordMetadata tableMetadata) {
<span class="fc" id="L54">        GenericRecordMetadata metadata = new GenericRecordMetadata();</span>
<span class="fc" id="L55">        int columnCount = tableMetadata.getColumnCount();</span>
<span class="fc" id="L56">        int timestampIndex = tableMetadata.getTimestampIndex();</span>
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">        if (tableMetadata instanceof ColumnMetadataCollection) {</span>
<span class="fc bfc" id="L58" title="All 2 branches covered.">            for (int i = 0; i &lt; columnCount; i++) {</span>
<span class="fc" id="L59">                TableColumnMetadata column = ((ColumnMetadataCollection) tableMetadata).getColumnMetadata(i);</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">                if (!column.isDeleted()) {</span>
<span class="fc" id="L61">                    metadata.add(column);</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">                    if (i == timestampIndex) {</span>
<span class="fc" id="L63">                        metadata.setTimestampIndex(metadata.getColumnCount() - 1);</span>
                    }
                }
            }
        } else {
<span class="nc bnc" id="L68" title="All 2 branches missed.">            for (int i = 0; i &lt; columnCount; i++) {</span>
<span class="nc" id="L69">                int columnType = metadata.getColumnType(i);</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">                if (columnType &gt;= 0) {</span>
<span class="nc" id="L71">                    metadata.add(</span>
                            new TableColumnMetadata(
<span class="nc" id="L73">                                    metadata.getColumnName(i),</span>
                                    columnType,
<span class="nc" id="L75">                                    metadata.isColumnIndexed(i),</span>
<span class="nc" id="L76">                                    metadata.getIndexValueBlockCapacity(i),</span>
<span class="nc" id="L77">                                    metadata.isSymbolTableStatic(i),</span>
<span class="nc" id="L78">                                    metadata.getMetadata(i),</span>
<span class="nc" id="L79">                                    metadata.getWriterIndex(i)</span>
                            )
                    );
<span class="nc bnc" id="L82" title="All 2 branches missed.">                    if (i == timestampIndex) {</span>
<span class="nc" id="L83">                        metadata.setTimestampIndex(metadata.getColumnCount() - 1);</span>
                    }
                }
            }
        }
<span class="fc" id="L88">        return metadata;</span>
    }

    public static GenericRecordMetadata copyOf(RecordMetadata that) {
<span class="fc bfc" id="L92" title="All 2 branches covered.">        if (that != null) {</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">            if (that instanceof GenericRecordMetadata) {</span>
<span class="fc" id="L94">                return (GenericRecordMetadata) that;</span>
            }
<span class="fc" id="L96">            GenericRecordMetadata metadata = copyOfSansTimestamp(that);</span>
<span class="fc" id="L97">            metadata.setTimestampIndex(that.getTimestampIndex());</span>
<span class="fc" id="L98">            return metadata;</span>
        }
<span class="fc" id="L100">        return null;</span>
    }

    public static GenericRecordMetadata copyOfSansTimestamp(RecordMetadata that) {
<span class="fc" id="L104">        GenericRecordMetadata metadata = new GenericRecordMetadata();</span>
<span class="fc" id="L105">        copyColumns(that, metadata);</span>
<span class="fc" id="L106">        return metadata;</span>
    }

    public static GenericRecordMetadata deepCopyOf(RecordMetadata that) {
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">        if (that != null) {</span>
<span class="fc" id="L111">            GenericRecordMetadata metadata = new GenericRecordMetadata();</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">            for (int i = 0, n = that.getColumnCount(); i &lt; n; i++) {</span>
<span class="fc" id="L113">                metadata.add(</span>
                        new TableColumnMetadata(
<span class="fc" id="L115">                                that.getColumnName(i),</span>
<span class="fc" id="L116">                                that.getColumnType(i),</span>
<span class="fc" id="L117">                                that.isColumnIndexed(i),</span>
<span class="fc" id="L118">                                that.getIndexValueBlockCapacity(i),</span>
<span class="fc" id="L119">                                that.isSymbolTableStatic(i),</span>
<span class="fc" id="L120">                                that.getMetadata(i),</span>
<span class="fc" id="L121">                                that.getWriterIndex(i)</span>
                        )
                );
            }
<span class="fc" id="L125">            metadata.setTimestampIndex(that.getTimestampIndex());</span>
<span class="fc" id="L126">            return metadata;</span>
        }
<span class="nc" id="L128">        return null;</span>
    }

    public static RecordMetadata removeTimestamp(RecordMetadata that) {
<span class="fc bfc" id="L132" title="All 2 branches covered.">        if (that.getTimestampIndex() != -1) {</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">            if (that instanceof GenericRecordMetadata) {</span>
<span class="fc" id="L134">                ((GenericRecordMetadata) that).setTimestampIndex(-1);</span>
<span class="fc" id="L135">                return that;</span>
            }
<span class="nc" id="L137">            return GenericRecordMetadata.copyOfSansTimestamp(that);</span>
        }
<span class="fc" id="L139">        return that;</span>
    }

    public GenericRecordMetadata add(TableColumnMetadata meta) {
<span class="fc" id="L143">        return add(columnCount, meta);</span>
    }

    public GenericRecordMetadata add(int i, TableColumnMetadata meta) {
<span class="fc" id="L147">        int index = columnNameIndexMap.keyIndex(meta.getName());</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">        if (index &gt; -1) {</span>
<span class="fc" id="L149">            columnNameIndexMap.putAt(index, meta.getName(), i);</span>
<span class="fc" id="L150">            columnMetadata.extendAndSet(i, meta);</span>
<span class="fc" id="L151">            columnCount++;</span>
<span class="fc" id="L152">            return this;</span>
        }
<span class="fc" id="L154">        throw CairoException.duplicateColumn(meta.getName());</span>
    }

    @Override
    public int getColumnIndexQuiet(CharSequence columnName, int lo, int hi) {
<span class="fc" id="L159">        final int index = columnNameIndexMap.keyIndex(columnName, lo, hi);</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">        if (index &lt; 0) {</span>
<span class="fc" id="L161">            return columnNameIndexMap.valueAt(index);</span>
        }
<span class="fc" id="L163">        return -1;</span>
    }

    public void setTimestampIndex(int index) {
<span class="fc" id="L167">        this.timestampIndex = index;</span>
<span class="fc" id="L168">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>